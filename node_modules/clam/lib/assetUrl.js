/**
 * Created with JetBrains WebStorm.
 * User: 陶清
 * Date: 13-11-1
 * Time: 下午4:05
 * Asset Url处理模块
 */
var debug = require('debug')('clam:assetUrl');
var config = require('./config.js');
var path = require('path');
var join = path.join;
var _ = require('underscore');

var scriptReg = /<script[^>]*? src\s{0,}=\s{0,}['"]\s{0,}(?!http(s)?:\/\/)(?!\/)([^"']*?)\s{0,}['"][^>]*?><\\?\/script>/g;
var styleReg = /<link[^>]*? href\s{0,}=\s{0,}['"]\s{0,}(?!http(s)?:\/\/)(?!\/)([^"']*?)\s{0,}['"][^>]*?>/g;
var absScript = /<script[^>]*? src\s{0,}=['"]\s{0,}(\/.+?)\s{0,}['"][^>]*?><\/script>/g;
var absStyle = /<link[^>]*? href\s{0,}=\s{0,}['"]\s{0,}(\/.+?)\s{0,}['"][^>]*?>/g;
var cdnPathReg = /http[s]?:\/\/[\w\.]+[\/.]*?/g;

/**
 * 解析在工程文件中配置的被解析到127.0.0.1的本地域名
 * @returns {Array}
 */
function localhosts(){
    var strHosts = config.get('project').hosts;

    var lines = strHosts.split(/[\n\r]{1,2}/);
    var hosts = [];
    lines.forEach(function(str){
        var units = str.split(/\s+/);
        if(units[0] == '127.0.0.1'){
            hosts = hosts.concat(units.slice(1,units.length));
        }
    });
    hosts = _.union(hosts);
    return hosts;
}

/**
 * 处理页面内容中的资源路径
 * 1. 本地相对路径转换为绝对路径
 * 2. 本地绝对路径增加端口号
 * 3. 以全cdnPath开头引入的格式资源，需要按照配置修改端口号，保证运行在非80端口上。
 *
 * @param pageContent  页面内容
 * @param urlDir       页面/模块文件相对根路径的位置
 * @return {String}    替换后的页面内容
 */
function toAbsolutePath(pageContent, urlDir) {
    var cdnPath = config.get('project').cdnPath;

    //处理模块中资源引用
    var localHosts = localhosts();
    debug('本地host列表[%s]', localHosts);

    /*/抽取cdn域名
    var cdnHost = cdnPath.match(cdnPathReg);
    if (cdnHost) {
        cdnHost = cdnHost[0];
    }
    else {
        cdnHost = '';
    }*/

    //以http开头的就改变cndPath中的端口号
    var port = config.get('project').port;
    var cdnPathWithPort = cdnPath;
    if (cdnPath.indexOf('http') === 0) {
        //如果是预览服务器运行在80端口，就不更改
        if (!port || port == 80) {
            port = '';
        }
        else {
            port = ':' + port;
        }
        var matchResult = cdnPath.match(/(http:\/\/[\w\.]+?)(\/.*)/);
        if (matchResult) {
            cdnPathWithPort = matchResult[1] + port + matchResult[2];
        }
    }

    var resourceRootDir = '';
    debug('资源跟路径%s', resourceRootDir);
    //debug('处理前内容%s', pageContent);
    //处理带域名的链接。1、增加端口号。2、增加时间戳路径
    localHosts.forEach(function(localHost){
        localHost = localHost.replace(/\./g, '\\.');
        var scriptWithDomain = new RegExp('<script[^>]*? src=[\'"](?:http[s]?:\\/\\/)(' + localHost + ')(.*)[\'"][^>]*?>', 'g');
        pageContent = pageContent.replace(scriptWithDomain, function ($1, $2) {
            return $1.replace($2, $2 + port);
        });
    });

    localHosts.forEach(function(localHost){
        localHost = localHost.replace(/\./g, '\\.');
        var styleWithDomain = new RegExp('<link[^>]*? href=[\'"](?:http[s]?:\\/\\/)(' + localHost + ')(.*)[\'"][^>]*?>', 'g');
        pageContent = pageContent.replace(styleWithDomain, function ($1, $2) {
            return $1.replace($2, $2 + port);
        });
    });
    //替换资源相对路径应为带域名和端口号的绝对路径，根据当前页面所在相对路径转换
    pageContent = pageContent.replace(scriptReg, function ($1, $2, $3) {
        if ($3.match(/^\$\{/)) {
            return $1;
        }
        else {
            var replacedPath = join(resourceRootDir, urlDir, $3).replace(/\\/ig, '/');
            if ($1.match(/clam-moveto/) && !$1.match(/clam-moveto\s{0,}=\s{0,}["']\s{0,}head\s{0,}["']/) && !$1.match(/clam-moveto\s{0,}=\s{0,}["']\s{0,}tail\s{0,}["']/)) {
                replacedPath = "$CLAM_VER$/"+replacedPath;
            }
            return $1.replace($3, cdnPathWithPort + '/' + replacedPath).replace(/["'](\s{0,})([^"']*?)(\s{0,})["']/g, function($1,$2,$3) {
                return '"'+$3+'"';
            });
        }
    });
    pageContent = pageContent.replace(styleReg, function ($1, $2, $3) {
        if ($3.match(/^\$\{/)) {
            return $1;
        }
        else {
            var replacedPath = join(resourceRootDir, urlDir, $3).replace(/\\/ig, '/');
            if ($1.match(/clam-moveto/) && !$1.match(/clam-moveto\s{0,}=\s{0,}["']\s{0,}head\s{0,}["']/) && !$1.match(/clam-moveto\s{0,}=\s{0,}["']\s{0,}tail\s{0,}["']/)) {
                console.log(replacedPath)
                replacedPath = "$CLAM_VER$/"+replacedPath;
            }
            return $1.replace($3, cdnPathWithPort + '/' + replacedPath).replace(/["'](\s{0,})([^"']*?)(\s{0,})["']/g, function($1,$2,$3) {
                return '"'+$3+'"';
            });
        }
    });

    //处理绝对路径引用。直接增加域名和端口号
    pageContent = pageContent.replace(absScript, function ($1, $2) {
        return $1.replace($2, cdnPathWithPort + $2);
    });
    pageContent = pageContent.replace(absStyle, function ($1, $2) {
        return $1.replace($2, cdnPathWithPort + $2);
    });
    //debug('处理后内容%s', pageContent);
    return pageContent;
}

exports.toAbsolutePath = toAbsolutePath;
