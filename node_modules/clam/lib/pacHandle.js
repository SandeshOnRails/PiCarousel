var url = require('url');
var path = require('path');

exports = module.exports = function () {
  return function (req, res, next) {
    var urlInfo = url.parse(req.url, true);
    var extname = path.extname(urlInfo.pathname);
    if (extname === '.pac') {
      var ipAddress = JSON.stringify(exports.localAddresses);
      var localAddress = req.connection.localAddress.split(':').pop();
      var pac = [
        'var ipAddress = ' + ipAddress + ';',
        'function FindProxyForURL (url, host) {',
          'var host = host.split(":")[0].toLowerCase();',
          'var url = url.toLowerCase();',
          'if (ipAddress.indexOf(host) != -1 || url.substring(0, 6) === "https:") {',
            'return "DIRECT;";',
          '}',
          'return "PROXY ' + localAddress +':9000; DIRECT;";',
        '}'
      ].join('\n\r');
      res.writeHeader(200, {
        "Content-Type": "application/octet-stream"
      });
      res.end(pac);
      return ;
    }
    next();
  };
};
exports.localAddresses = [];
var _ = require('underscore');
_.each(require('os').networkInterfaces(), function (networkInterface) {
  _.each(networkInterface, function (item) {
    exports.localAddresses.push(item.address);
  });
});