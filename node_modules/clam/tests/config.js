var path = require('path');
process.argv.push('--root');
process.argv.push(path.join(__dirname, 'config', 'testroot'));
var config = require('../lib/config.js');
var debug = require('debug')('config test');
var assert = require('assert');
var beautify = require('../lib/util/beautify.js').js_beautify;
var fs = require('fs');
var util = require('util');

describe('配置管理', function () {
    it('基本功能', function () {

        //测试开始，构造环境
        var clamRepo = path.join(__dirname, 'config/.clam');
        if(!fs.existsSync(clamRepo)){
            fs.mkdirSync(clamRepo);
        }

        config.set('project', {aa:'bb'});
        var e = config.get('project');
        assert.deepEqual(e.aa, 'bb');
        var info = fs.readFileSync(path.join(__dirname, 'config/.clam/project.json'));
        info = info.toString().replace(/[\n\r]/g, '');
        info = JSON.parse(info);
        assert.deepEqual(info.aa, 'bb');
    });

    it('获取项目根目录', function () {
        var root = config.root();
        var expired = path.join(__dirname, 'config');
        assert.deepEqual(root, expired);
    });

    it('文件监听', function () {
        //先把aa值设置为bb,然后再通过文件修改设置为cc。检查是否可以监听到内容修改
        config.set('page', {aa:'bb'});
        var e = config.get('page');
        assert.deepEqual(e.aa, 'bb');
        var pageFile = path.join(__dirname, 'config/.clam/page.json');

        config.on('pageChange', function (key) {
            debug('修改内容%s', key);
            assert.deepEqual(config.get('page').aa, 'cc');
        });
        fs.writeFileSync(pageFile, beautify(JSON.stringify({aa:'cc'})));


        //测试完毕，系统清理
        var clamRepo = path.join(__dirname, 'config/.clam');
        if (fs.existsSync(clamRepo)) {
            var files = fs.readdirSync(clamRepo);
            files.forEach(function (file, i) {
                fs.unlinkSync(path.join(__dirname, 'config/.clam/', file));
            });
            fs.rmdirSync(clamRepo);
        }
    });
});