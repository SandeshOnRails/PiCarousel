var path = require('path');
process.argv.push('--root');
process.argv.push(path.join(__dirname, 'project')); //以测试目录下config目录为项目根目录
var project = require('../lib/project.js');
var debug = require('debug')('clam:projectTest');
var assert = require('assert');
var util = require('util');
var fs = require('fs');

describe('项目管理', function () {
    it('获取空项目信息', function () {
        var info = project();
        debug('项目:%s', util.inspect(info));
        assert.deepEqual(info.state, 'blank');
        //assert.equals('1','1');
    });

    it('设置项目', function(){
        var info = project();
        info.cdnPath = '/aaa';
        project(info);
        info = project();
        assert.deepEqual(info.cdnPath, '/aaa');

        //检查持久化
        var c = fs.readFileSync(path.join(__dirname, 'project/.clam/project.json'));
        c = c.toString().replace(/[\n\r]/g, '');
        c = JSON.parse(c);
        assert.deepEqual(c.cdnPath, '/aaa');
    });

    it('清理环境', function(){

        //测试完毕，系统清理
        var clamRepo = path.join(__dirname, 'project/.clam');
        if (fs.existsSync(clamRepo)) {
            var files = fs.readdirSync(clamRepo);
            files.forEach(function (file, i) {
                fs.unlinkSync(path.join(__dirname, 'project/.clam/', file));
            });
            fs.rmdirSync(clamRepo);
        }
    });
});